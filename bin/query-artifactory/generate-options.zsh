#!/bin/zsh
# Generate Docker and Helm options lists from repository structure
#
# This script scans:
# - sre/apps and database/apps for directories containing Dockerfiles
# - sre/charts and database/charts for directories containing Chart.yaml
#
# It generates two files:
# - .docker-options : list of Docker app names
# - .helm-options   : list of Helm chart names
#
#
# .docker-options and .helm-options are used by the query-artifactory zsh script
# to provide interactive selection of available Docker images and Helm charts.
#

set -e

# Determine the script's directory
SCRIPT_DIR="${0:a:h}"
DOCKER_OUTPUT_FILE="${SCRIPT_DIR}/.docker-options"
HELM_OUTPUT_FILE="${SCRIPT_DIR}/.helm-options"

echo "üîç Scanning for Dockerfiles and Chart.yaml files..."

# Array to store Docker app names
DOCKER_APP_NAMES=()

# Find all Dockerfiles in sre/apps
if [[ -d "${SCRIPT_DIR}/../../apps" ]]; then
  while IFS= read -r dockerfile; do
    # Extract the app name from the path (parent directory of Dockerfile)
    app_name=$(basename $(dirname "$dockerfile"))
    DOCKER_APP_NAMES+=("$app_name")
  done < <(find "${SCRIPT_DIR}/../../apps" -name Dockerfile -type f)
fi

# Find all Dockerfiles in database/apps
if [[ -d "${SCRIPT_DIR}/../../../database/apps" ]]; then
  while IFS= read -r dockerfile; do
    # Extract the app name from the path (parent directory of Dockerfile)
    app_name=$(basename $(dirname "$dockerfile"))
    DOCKER_APP_NAMES+=("$app_name")
  done < <(find "${SCRIPT_DIR}/../../../database/apps" -name Dockerfile -type f)
fi

# Sort and deduplicate Docker apps
DOCKER_APP_NAMES=(${(u)DOCKER_APP_NAMES})
DOCKER_APP_NAMES=("${(@o)DOCKER_APP_NAMES}")

# Write Docker options to output file
echo "# Auto-generated Docker options" > "$DOCKER_OUTPUT_FILE"
echo "# Generated on $(date)" >> "$DOCKER_OUTPUT_FILE"
echo "# Do not edit this file manually - run generate-options.zsh instead" >> "$DOCKER_OUTPUT_FILE"
echo "" >> "$DOCKER_OUTPUT_FILE"

for app in "${DOCKER_APP_NAMES[@]}"; do
  echo "$app" >> "$DOCKER_OUTPUT_FILE"
done

echo "‚úÖ Generated ${#DOCKER_APP_NAMES[@]} Docker options in ${DOCKER_OUTPUT_FILE}"

# Array to store Helm chart names
HELM_CHART_NAMES=()

# Find all Chart.yaml files in sre/charts
if [[ -d "${SCRIPT_DIR}/../../charts" ]]; then
  while IFS= read -r chart_yaml; do
    # Extract the chart name from the path (parent directory of Chart.yaml)
    chart_name=$(basename $(dirname "$chart_yaml"))
    HELM_CHART_NAMES+=("$chart_name")
  done < <(find "${SCRIPT_DIR}/../../charts" -name Chart.yaml -type f)
fi

# Find all Chart.yaml files in database/charts
if [[ -d "${SCRIPT_DIR}/../../../database/charts" ]]; then
  while IFS= read -r chart_yaml; do
    # Extract the chart name from the path (parent directory of Chart.yaml)
    chart_name=$(basename $(dirname "$chart_yaml"))
    HELM_CHART_NAMES+=("$chart_name")
  done < <(find "${SCRIPT_DIR}/../../../database/charts" -name Chart.yaml -type f)
fi

# Sort and deduplicate Helm charts
HELM_CHART_NAMES=(${(u)HELM_CHART_NAMES})
HELM_CHART_NAMES=("${(@o)HELM_CHART_NAMES}")

# Write Helm options to output file
echo "# Auto-generated Helm options" > "$HELM_OUTPUT_FILE"
echo "# Generated on $(date)" >> "$HELM_OUTPUT_FILE"
echo "# Do not edit this file manually - run generate-options.zsh instead" >> "$HELM_OUTPUT_FILE"
echo "" >> "$HELM_OUTPUT_FILE"

for chart in "${HELM_CHART_NAMES[@]}"; do
  echo "$chart" >> "$HELM_OUTPUT_FILE"
done

echo "‚úÖ Generated ${#HELM_CHART_NAMES[@]} Helm options in ${HELM_OUTPUT_FILE}"
echo ""
echo "Summary:"
echo "  Docker apps: ${#DOCKER_APP_NAMES[@]}"
echo "  Helm charts: ${#HELM_CHART_NAMES[@]}"
