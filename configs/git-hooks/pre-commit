#!/bin/sh

# Prevent accidental commits to main/master branches
branch=$(git symbolic-ref --short HEAD 2>/dev/null)
origin_url=$(git config --get remote.origin.url 2>/dev/null)

if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
    # Allow main/master commits only for clarkritchie-owned repos.
    case "$origin_url" in
        git@github.com:clarkritchie/*|https://github.com/clarkritchie/*)
            :
            ;;
        *)
            echo "‚ùå Direct commits to $branch are not allowed!"
            echo "üí° Create a feature branch instead:"
            echo "   git co <branch-name>"
            exit 1
            ;;
    esac
fi

# strip trailing whitespace
files=$(git diff --cached --name-only --diff-filter=ACM)
if [ -n "$files" ]; then
    for file in $files; do
        if [ -f "$file" ]; then
            perl -pi -e 's/[ \t]+$//' "$file"
            git add "$file"
        fi
    done
fi

# block merge conflict markers
if [ -n "$files" ]; then
    if git diff --cached --name-only --diff-filter=ACM -z | xargs -0 grep -nE "^(<<<<<<<|=======|>>>>>>>)" >/dev/null 2>&1; then
        echo "‚ùå Merge conflict markers found in staged files. Resolve them before committing."
        exit 1
    fi
fi

# convert tabs to spaces in staged files
if [ -n "$files" ]; then
    for file in $files; do
        if [ -f "$file" ]; then
            if grep -q $'\t' "$file"; then
                echo "‚ö†Ô∏è  Converted tabs to spaces in $file"
                perl -pi -e 's/\t/    /g' "$file"
                git add "$file"
            fi
        fi
    done
fi

# block large files (default 1MB)
max_bytes=1048576
if [ -n "$files" ]; then
    for file in $files; do
        if [ -f "$file" ]; then
            file_bytes=$(wc -c < "$file" | tr -d ' ')
            if [ "$file_bytes" -gt "$max_bytes" ]; then
                echo "‚ùå $file is $file_bytes bytes (over ${max_bytes})."
                echo "üí° Use Git LFS or reduce the file size."
                exit 1
            fi
        fi
    done
fi

exit 0
