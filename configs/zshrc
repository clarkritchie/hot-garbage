# --- Oh My Zsh & Theme Setup ---
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="amuse"
export GCP_ZSH_THEME="dpoggi"
plugins=(git virtualenv iterm2 helm gcloud kubectl kubectx kube-ps1)
source $ZSH/oh-my-zsh.sh

# --- PATH Setup (using array for clarity) ---
typeset -U path
path=(
  /opt/homebrew/bin
  /opt/homebrew/sbin
  /usr/bin
  /usr/local/bin
  /bin
  /usr/sbin
  /sbin
  /var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin
  /var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin
  /var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin
  Library/Apple/usr/bin
  /Applications/CyberArk\ EPM.app/Contents/MacOS
  /System/Cryptexes/App/usr/bin
  /Applications/iTerm.app/Contents/Resources/utilities
  $HOME/.rd/bin
  /opt/homebrew/share/google-cloud-sdk/bin
  $HOME/Projects/dexcom-inc/sre/etc
  $HOME/Projects/clarkritchie/hot-garbage/bin
  # $(go env GOPATH)/bin
  /opt/homebrew/Cellar/mysql-client/8.3.0/bin
  /opt/homebrew/opt/libpq/bin
  $HOME/.local/bin
  $path
)
export PATH

# --- Aliases ---
alias alt-kubeconfig='export KUBECONFIG=~/.kube/config-alt'
alias chart-bump="$HOME/Projects/clarkritchie/hot-garbage/bin/bump-helm-chart-version.zsh"
alias create-pr='create-pr.zsh'
alias current-tag='git describe --tags'
alias fix-whitespace="sed -i '' 's/[[:space:]]*$//' $1"
alias get-argo-secret='k get secret argocd-initial-admin-secret -n argocd -o jsonpath="{.data}" | jq -r '\''to_entries[] | "\(.key): \(.value | @base64d)"'\'
alias git-sha='git rev-parse --short HEAD'
alias git-tags='git fetch origin --tags && git tag --list --sort=creatordate | tail -1'
alias go-database='cd ~/Projects/dexcom-inc/database'
alias go-sre='cd ~/Projects/dexcom-inc/sre'
alias go-sre-libs='cd ~/Projects/dexcom-inc/sre-libs'
alias h='history'
alias ls="ls -la --color"
alias no-alt-kubeconfig='unset KUBECONFIG'
alias rm-bak-files="find . -name '*.bak' -exec rm -f {} \;"
alias run-porcelain="git status --porcelain | grep '^??' | cut -c4- | xargs rm -rf"

# --- Functions ---
new-zshrc() {
  local src=~/Projects/clarkritchie/hot-garbage/configs/zshrc
  local dest=~/.zshrc
  local backup1='Library/Mobile Documents/iCloud~md~obsidian/Documents/Misc/obsidian-backup/Code/zshrc.zsh'
  echo "Installing new .zshrc"
  # redirect to silence command not found with path
  cp "$src" "$dest" && source "$dest" 2>/dev/null
  cp "$src" "${HOME}/$backup1"
}

# New Configs script and alias
temp_file=$(mktemp)
cat <<EOF > "$temp_file"
#!/usr/bin/env python3
import os
import shutil

# Use a list of tuples to handle multiple destinations for the same source
config_files = [
    (os.path.expanduser("~/Projects/clarkritchie/hot-garbage/configs/copilot-instructions.md"), os.path.expanduser("~/Projects/dexcom-inc/sre/.github")),
    (os.path.expanduser("~/Projects/clarkritchie/hot-garbage/configs/copilot-instructions.md"), os.path.expanduser("~/Projects/dexcom-inc/database/.github")),
    (os.path.expanduser("~/Projects/clarkritchie/hot-garbage/configs/gitconfig"), os.path.expanduser("~/.gitconfig")),
    (os.path.expanduser("~/Projects/clarkritchie/hot-garbage/configs/Projects_main.code-workspace"), os.path.expanduser("~/Projects/Projects_main.code-workspace")),
]

for src, dest in config_files:
    print(f"{src} ➡️ {dest}")
    if os.path.isfile(src):
        shutil.copy2(src, dest)
        print(f"✅ Copied {os.path.basename(src)} to {dest}")
    else:
        print(f"⚠️  Warning: {src} not found")
EOF
chmod +x "$temp_file"
alias new-configs="python3 $temp_file"

# Function to decode and print all keys/values from a Kubernetes secret
kdec(){
   kubectl get secret $1 -o go-template='{{range $k,$v := .data}}{{printf "%s: " $k}}{{if not $v}}{{$v}}{{else}}{{$v | base64decode}}{{end}}{{"\n"}}{{end}}'
}

# Kube PS1 prompt
# https://github.com/jonmosco/kube-ps1

# Function to show KUBECONFIG status in prompt if $KUBECONFIG is currently pointed elsewhere
kubeconfig-status() {
  local default_config="$HOME/.kube/config"
  if [[ -n "$KUBECONFIG" && "$KUBECONFIG" != "$default_config" ]]; then
    echo " ✴️ Alt KUBECONFIG"
  fi
}

# --- K8s Shortcuts ---
alias k=kubectl
alias klc="k config get-contexts"
alias kcc="k config current-context"
alias kuc="k config use-context"
alias kns="k get namespaces"
alias kdp='f() { k describe pod $1 };f'
alias kun='f() { k config set-context --current --namespace=$1 };f'
kgo() {
  pod=$(kubectl get pods --no-headers | awk "NR==$1" | awk '{print $1}')
  echo "Getting a shell in $pod"
  kubectl exec --stdin --tty "$pod" -- /bin/bash
}
alias kevents='kubectl get events --sort-by=".metadata.creationTimestamp"'

# k logs pod/dexcom-datadog-operator-d96ddf49d-ccrnh | jq 'select(.level == "ERROR" and .logger != "controllers.DatadogGenericResource")'
# kerror() {
#   k logs "$1" | jq 'select(.level == "ERROR")'
# }



# --- OS-Specific Aliases ---

# if [[ "$OSTYPE" == "darwin"* ]]; then
#   alias argo-port-forward='k port-forward svc/argocd-platform-server 8082:80 -n argocd --context=$(kubectx -c) & sleep 2 && open http://localhost:8082'
# else
#   alias argo-port-forward='k port-forward svc/argocd-platform-server 8082:80 -n argocd --context=$(kubectx -c) & sleep 2 && xdg-open http://localhost:8082'
# fi

argo-port-forward() {
  get-argo-secret

  # Check if port-forward to localhost:8082 is already running
  RUNNING_PID=$(pgrep -f "kubectl port-forward svc/argocd-platform-server 8082:80 -n argocd")
  if [[ -n "$RUNNING_PID" ]]; then
    echo "Port-forward to localhost:8082 is already runnin with PID ${RUNNING_PID}. Exiting."
    return 1
  fi

  # Run port-forward and open browser based on OS
  if [[ "$OSTYPE" == "darwin"* ]]; then
    k port-forward svc/argocd-platform-server 8082:80 -n argocd --context=$(kubectx -c)
    # sleep 2 && open http://localhost:8082
  else
    k port-forward svc/argocd-platform-server 8082:80 -n argocd --context=$(kubectx -c)
    # sleep 2 && xdg-open http://localhost:8082
  fi
}

# --- Miscellaneous ---
export TABSTOP=2
export CLOUDSDK_PYTHON_SITEPACKAGES=1

# --- Source Additional Configs ---
for file in "$HOME/Projects/etc/api-keys.zshrc" "$HOME/Projects/etc/clark-more-zsh.zshrc" "$HOME/Projects/etc/cloudsql-aliases.zshrc"; do
  [[ -f $file ]] && source $file
done

#!/usr/bin/env python3

import os

# Path to the Chart.yaml file
file_path = '/workspace/dexcom-inc/sre/charts/databridge-test/Chart.yaml'

# Read the file
with open(file_path, 'r') as f:
    lines = f.readlines()

# Line 9 is index 8 (0-based)
line_9 = lines[8]

# Define the remote and local repository strings
remote_repo = 'https://dexcom.jfrog.io/artifactory/api/helm/dexcom-helm-dev-virtual'
local_repo = 'file://./charts'  # Adjust this to your desired local directory

# Toggle the repository
if remote_repo in line_9:
    lines[8] = line_9.replace(remote_repo, local_repo)
    print("Toggled to local directory: file://./charts")
else:
    lines[8] = line_9.replace(local_repo, remote_repo)
    print("Toggled back to remote repository")

# Write back to the file
with open(file_path, 'w') as f:
    f.writelines(lines)
    
# --- rbenv ---
eval "$(rbenv init -)"

# --- Prompt Customization ---
PROMPT='$(kube_ps1)$(kubeconfig-status) '$PROMPT

# iTerm2 profile switcher
typeset -a ITERM_PROFILES
ITERM_PROFILES=(
  "Default"
  # "idleToes"
  "Fairyfloss"
  "ToyChest"
  "GruvboxDark"
  "Purple Rain"
  "MaterialDark"
  "FrontEndDelight"
  "Jackie Brown"
)


# Pick a random profile
setopt KSH_ARRAYS
index=$((RANDOM % ${#ITERM_PROFILES[@]}))
random_profile=${ITERM_PROFILES[$index]}
# Show the profile name scrolling across the terminal
# echo "Using iTerm2 Profile: $random_profile"
# Apply the profile
echo -e "\033]50;SetProfile=$random_profile\a"
unsetopt KSH_ARRAYS

# --- End of zshrc ---
